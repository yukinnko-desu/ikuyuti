<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>イベント - ゆっちん育成ゲーム</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      .event-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        padding: 20px;
        text-align: center;
        background-image: url("images/kusamura.png");
        background-size: cover;
        background-position: center;
        position: relative;
      }

      .event-message {
        font-size: 24px;
        line-height: 1.6;
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        color: black;
      }

      .event-message--happy {
        font-size: 32px;
        font-weight: 700;
      }

      .hako-image {
        position: absolute;
        top: 80%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 300%;
        max-height: 100%;
        object-fit: contain;
        z-index: 2;
      }

      .event-image {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 55%;
        max-height: 55%;
        object-fit: contain;
        z-index: 3;
      }

      .speech-bubble {
        position: absolute;
        top: 28%;
        left: 65%;
        transform: translateY(-50%);
        width: 360px;
        max-width: none;
        padding: 12px 16px;
        background-color: white;
        color: black;
        border: 2px solid black;
        border-radius: 16px;
        font-size: 20px;
        font-weight: 500;
        white-space: nowrap;
        z-index: 4;
      }

      .speech-bubble::before {
        content: "";
        position: absolute;
        left: -18px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 10px 18px 10px 0;
        border-style: solid;
        border-color: transparent black transparent transparent;
      }

      .speech-bubble::after {
        content: "";
        position: absolute;
        left: -14px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 8px 14px 8px 0;
        border-style: solid;
        border-color: transparent white transparent transparent;
      }

      .button-container {
        display: flex;
        gap: 20px;
        position: absolute;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
      }

      .choice-button {
        padding: 15px 30px;
        font-size: 18px;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .choice-button:hover {
        transform: scale(1.05);
      }

      .give-button {
        background-color: #4caf50;
      }

      .give-button:hover {
        background-color: #45a049;
      }

      .no-give-button {
        background-color: #f44336;
      }

      .no-give-button:hover {
        background-color: #da190b;
      }

      .event-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.35);
        z-index: 100;
      }

      .event-modal__card {
        background-color: white;
        border: 2px solid #111;
        border-radius: 6px;
        padding: 24px 32px;
        width: min(720px, 88vw);
        text-align: center;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
      }

      .event-modal__title {
        font-size: 24px;
        font-weight: 700;
        color: black;
        margin: 0;
        line-height: 1.6;
      }

      .happy-speech-bubble {
        position: absolute;
        top: 32%;
        left: 65%;
        transform: translateY(-50%);
        width: 300px;
        padding: 16px 20px;
        background-color: white;
        color: black;
        border: 3px solid black;
        border-radius: 20px;
        font-size: 24px;
        font-weight: 600;
        white-space: nowrap;
        z-index: 5;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .happy-speech-bubble::before {
        content: "";
        position: absolute;
        left: -20px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 12px 20px 12px 0;
        border-style: solid;
        border-color: transparent black transparent transparent;
      }

      .happy-speech-bubble::after {
        content: "";
        position: absolute;
        left: -14px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 8px 14px 8px 0;
        border-style: solid;
        border-color: transparent white transparent transparent;
      }

      @keyframes happySway {
        0% {
          transform: translate(-50%, -50%) rotateZ(0deg) scale(1);
          filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
        }
        25% {
          transform: translate(-50%, -50%) rotateZ(12deg) scale(1.05);
          filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
        }
        50% {
          transform: translate(-50%, -50%) rotateZ(-12deg) scale(1.05);
          filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
        }
        75% {
          transform: translate(-50%, -50%) rotateZ(12deg) scale(1.05);
          filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
        }
        100% {
          transform: translate(-50%, -50%) rotateZ(0deg) scale(1);
          filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
        }
      }

      .event-image.happy {
        animation: happySway 1s ease-in-out infinite;
      }

      @keyframes bubblePop {
        0% {
          opacity: 0;
          transform: translateY(-50%) scale(0.6);
        }
        100% {
          opacity: 1;
          transform: translateY(-50%) scale(1);
        }
      }

      .happy-speech-bubble.animated {
        animation: bubblePop 0.5s ease-out;
      }

      .sad-speech-bubble {
        position: absolute;
        top: 32%;
        left: 65%;
        transform: translateY(-50%);
        width: 180px;
        padding: 12px 16px;
        background-color: white;
        color: #222;
        border: 2px solid #333;
        border-radius: 16px;
        font-size: 20px;
        font-weight: 600;
        white-space: nowrap;
        z-index: 6;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }

      .sad-speech-bubble::before {
        content: "";
        position: absolute;
        left: -16px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 8px 16px 8px 0;
        border-style: solid;
        border-color: transparent #333 transparent transparent;
      }

      .rain-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 50;
        overflow: hidden;
      }

      .rain-drop {
        position: absolute;
        width: 150px;
        height: 150px;
        background-image: url("images/marugeri-ta.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
      }

      @keyframes rainFall {
        0% {
          transform: translateY(-100px) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0.3;
        }
      }

      .rain-drop.falling {
        animation: rainFall linear forwards;
      }
    </style>
  </head>
  <body>
    <div class="event-screen">
      <div class="event-message" id="event-message"></div>
      <img src="images/hako.png" alt="" class="hako-image" />
      <img
        src="images/kuuhu.jpg"
        alt="ゆっちん"
        class="event-image"
        id="event-image"
      />
      <div class="speech-bubble" id="speech-bubble">
        ご飯を食べたいと思いませんか
      </div>
      <div class="button-container">
        <button class="choice-button give-button" id="give-button">
          あげる
        </button>
        <button class="choice-button no-give-button" id="no-give-button">
          あげない
        </button>
      </div>

      <div id="hungry-modal" class="event-modal" hidden>
        <div class="event-modal__card">
          <p class="event-modal__title" id="hungry-text">
            おなかがすいたみたい
          </p>
        </div>
      </div>
    </div>

    <script>
      // 要素の取得
      const messageElement = document.getElementById("event-message");
      const giveButton = document.getElementById("give-button");
      const noGiveButton = document.getElementById("no-give-button");
      const eventImage = document.getElementById("event-image");
      const speechBubble = document.getElementById("speech-bubble");
      const hungryModal = document.getElementById("hungry-modal");

      // マルゲリータ雨を生成する関数
      function startRain() {
        const rainContainer = document.createElement("div");
        rainContainer.className = "rain-container";
        document.body.appendChild(rainContainer);

        const rainDuration = 16000; // 16秒
        const dropCount = 30; // 降らせる画像数
        const dropDuration = 3000; // 各ドロップが落ちるのにかかる時間（ミリ秒）

        // 初期ドロップを生成
        function createDrop() {
          const drop = document.createElement("div");
          drop.className = "rain-drop falling";
          drop.style.left = Math.random() * 100 + "%";
          drop.style.animationDuration = (dropDuration + Math.random() * 2000) + "ms";
          drop.style.animationDelay = Math.random() * 1000 + "ms";
          rainContainer.appendChild(drop);

          // アニメーション終了後にドロップを削除
          const animationDuration = parseFloat(drop.style.animationDuration);
          const animationDelay = parseFloat(drop.style.animationDelay);
          setTimeout(() => {
            drop.remove();
          }, animationDuration + animationDelay);
        }

        // 16秒間、定期的にドロップを生成
        const rainInterval = setInterval(() => {
          for (let i = 0; i < 3; i++) {
            createDrop();
          }
        }, 200);

        // 16秒後に雨を停止
        setTimeout(() => {
          clearInterval(rainInterval);
          // 残りのドロップがアニメーション終了後に自動削除されるため、
          // ここではコンテナ全体を削除するのを少し遅延させる
          setTimeout(() => {
            rainContainer.remove();
          }, dropDuration + 1000);
        }, rainDuration);
      }
    
      const kanashimiSe = new Audio("sounds/kanasimi_asioto.mp3");
      kanashimiSe.preload = "auto";
      // 喜びシーン用の効果音
      const sambaSe = new Audio("sounds/Samba Janeiro Full.mp3");
      sambaSe.preload = "auto";
      // モーダル表示中は効果音を抑制するフラグ
      let suppressKanashimiSe = false;

      // ページ読み込み時にモーダルを2秒表示
      window.addEventListener("load", () => {
        hungryModal.removeAttribute("hidden");
        setTimeout(() => {
          hungryModal.style.display = "none";
        }, 2000);
      });

      // 「あげない」ボタン - 画像を悲しいものに変えてからmain.htmlに戻る
      noGiveButton.addEventListener("click", () => {
        // 画像を変更
        eventImage.src = "images/kanasimicchin_mini.png";
        // （モーダル表示中は鳴らさない）
        // 初期クリック時はモーダルを表示するため、ここでは再生しない

        // ボタンを非表示にして二度押し防止
        const buttonContainer = document.querySelector(".button-container");
        if (buttonContainer) {
          buttonContainer.style.display = "none";
        }

        // スピーチバブルを非表示
        if (speechBubble) {
          speechBubble.style.display = "none";
        }

        // 悲しい吹き出しを表示（文言は「かなしいです…」）
        const sadSpeechBubble = document.createElement("div");
        sadSpeechBubble.className = "sad-speech-bubble";
        sadSpeechBubble.textContent = "かなしいです…";
        sadSpeechBubble.style.display = "none";  // 初期状態では非表示
        const eventScreen = document.querySelector(".event-screen");
        eventScreen.appendChild(sadSpeechBubble);

        // 「ゆっちんが悲しんでいる」モーダルを作成・表示
        const sadModal = document.createElement("div");
        sadModal.className = "event-modal";
        sadModal.innerHTML = `
          <div class="event-modal__card">
            <p class="event-modal__title">ゆっちんが悲しんでいる</p>
          </div>
        `;
        // モーダル表示中は効果音を抑制する
        suppressKanashimiSe = true;
        eventScreen.appendChild(sadModal);

        // 2.5秒後にモーダルを消して、その後に画像シーケンスを表示

        setTimeout(() => {
          sadModal.style.display = "none";
          // モーダルを消したので効果音を再開
          suppressKanashimiSe = false;

          // シーケンス中はクリック無効化
          eventImage.style.pointerEvents = "none";
          sadSpeechBubble.style.pointerEvents = "none";

          // シーケンス: mini -> tyu -> full
          const showMini = () => {
            eventImage.src = "images/kanasimicchin_mini.png";
            eventImage.style.transform = "translate(-50%, -50%) scale(1.25)";
            if (!suppressKanashimiSe) { try { kanashimiSe.currentTime = 0; kanashimiSe.play(); } catch (e) {} }
          };
          const showTyu = () => {
            eventImage.src = "images/kanasimicchin_tyu.png";
            eventImage.style.transform = "translate(-50%, -50%) scale(1.55)";
            if (!suppressKanashimiSe) { try { kanashimiSe.currentTime = 0; kanashimiSe.play(); } catch (e) {} }
          };
          const showFull = () => {
            eventImage.src = "images/kanasimicchin.png";
            eventImage.style.transform = "translate(-50%, -50%) scale(1.85)";
            if (!suppressKanashimiSe) { try { kanashimiSe.currentTime = 0; kanashimiSe.play(); } catch (e) {} }

            // kanasimicchin.png表示後に吹き出しを表示してクリックで戻るようにする
            setTimeout(() => {
              sadSpeechBubble.style.display = "block";
              sadSpeechBubble.style.cursor = "pointer";
              eventImage.style.cursor = "pointer";
              eventImage.style.pointerEvents = "auto";
              sadSpeechBubble.style.pointerEvents = "auto";

              const onSadClick = () => {
                eventImage.removeEventListener("click", onSadClick);
                sadSpeechBubble.removeEventListener("click", onSadClick);
                localStorage.removeItem("yuttinEventTapCount");
                window.location.href = "main.html";
              };

              eventImage.addEventListener("click", onSadClick);
              sadSpeechBubble.addEventListener("click", onSadClick);
            }, 300);
          };

          // 実行タイミング
          showMini();
          setTimeout(() => {
            showTyu();
            setTimeout(() => {
              showFull();
            }, 700);
          }, 700);
        }, 2500);
      });

      // 「あげる」ボタン - 画像をyorokobi.jpgに変更
      giveButton.addEventListener("click", () => {
        eventImage.src = "images/yorokobi.jpg";
        // 画像にアニメーションクラスを追加
        eventImage.classList.add("happy");

        // ボタンを非表示
        const buttonContainer = document.querySelector(".button-container");
        buttonContainer.style.display = "none";

        // スピーチバブルを非表示
        if (speechBubble) {
          speechBubble.style.display = "none";
        }

        // 喜びの舞の吹き出しを作成・表示
        const happySpeechBubble = document.createElement("div");
        happySpeechBubble.className = "happy-speech-bubble animated";
        happySpeechBubble.textContent = "喜びの舞";
        const eventScreen = document.querySelector(".event-screen");
        eventScreen.appendChild(happySpeechBubble);

        // 「ゆっちんがうれしそう」モーダルを作成・表示
        const happyModal = document.createElement("div");
        happyModal.className = "event-modal";
        happyModal.innerHTML = `
          <div class="event-modal__card">
            <p class="event-modal__title">ゆっちんがうれしそう</p>
          </div>
        `;
        document.querySelector(".event-screen").appendChild(happyModal);

        // 2秒後にモーダルを消す
        setTimeout(() => {
          happyModal.style.display = "none";
          // 「ゆっちんがうれしそう」消去後にSEを再生
          sambaSe.currentTime = 0;
          sambaSe.play().catch((error) => {
            console.log("音声の再生に失敗:", error);
          });

          // マルゲリータを雨のように降らせる
          startRain();
        }, 2500);

        // 3秒後に画像をクリック可能にして、クリックでmain.htmlに戻る
        setTimeout(() => {
          eventImage.style.cursor = "pointer";
          eventImage.addEventListener("click", () => {
            localStorage.removeItem("yuttinEventTapCount");
            window.location.href = "main.html";
          });
        }, 3000);
      });
    </script>
  </body>
</html>
